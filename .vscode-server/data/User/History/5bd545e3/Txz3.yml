---
  hosts: localhost
  become: yes
  gather_facts: no
  vars_files:
    - /home/ndao/mysql_setup/vars/mysql_vars.yml
  vars_prompt:
    name: mysql_root_password
    prompt: "Mot de passe, Root"
    private: yes
  tasks:
    - name: Create or update databases and users
      block:
        - name: Check if user exists before creation
          command: mysql -e "SELECT user FROM mysql.user WHERE user='{{ item.user }}'"
          register: user_check
          ignore_errors: yes

        - name: Display message if user already exists
          debug:
            message: "User {{ item.user }} already exists"
          when: user_check.rc == 0

        - name: Create database if not exists
          mysql_db:
            name: "{{ item.name }}"
            state: present
            login_unix_socket: /var/run/mysqld/mysqld.sock
            login_password: "{{ mysql_root_password }}"
            login_user: root

        - name: Create user if not exists
          mysql_user:
            name: "{{ item.user }}"
            password: "{{ item.password }}"
            priv: "{{ item.name }}.*:ALL"
            state: present
            update_password: on_create
            login_unix_socket: /var/run/mysqld/mysqld.sock
            login_password: "{{ mysql_root_password }}"
            login_user: root
      loop: "{{ databases }}"
      loop_control:
        loop_var: item
