---
- hosts: all
  become: yes
  gather_facts: no
  vars_files: vars/credentials.yaml
  vars:
    db_user: "stg_ndao75268"
    db_ip: "10.137.21.115"
    db_port: "6446"
    ansible_ssh_user: 'diop028863'
    ansible_ssh_pass: "{{ ctd_password_tacacs }}"
    ansible_become_password: "{{ ctd_password_tacacs }}"
    # ansible_python_interpreter: /bin/python3
  tasks:
    - name: Add a host alias that we reach through a tunnel (Ansible 2.0 and newer)
      add_host:
        hostname: '10.137.21.115'

    - name: block
      block:
        - name: Initialize results list
          set_fact:
            db_results: []

        - name: Loop through databases and users
          include_tasks: sql_setup.yml
          loop: "{{ databases }}"
          loop_control:
            loop_var: db_item
        
        # Send mail with accumulated results

        - name: Envoyer un email avec les détails de la base de données et de l'utilisateur créés
          mail:
            host: "webmail.orange-sonatel.com"
            port: 25
            to: "{{ demandeur }}"
            cc:
              - "CheikhIbrahima.NDAO@orange-sonatel.com"
            from: "{{ approbateur }}"
            subject: "Détails des bases de données et des utilisateurs MySQL créés"
            body: |
              {% for result in db_results %}
              {% if not result.db_exists and not result.user_exists %}
              Database created: {{ result.database }}
              User created: {{ result.user }}
              User password: {{ result.password }}
              {% elif result.db_exists and not result.user_exists %}
              L'utilisateur {{ result.user }} a été créé et recevra les privilèges pour la base de données {{ result.database }} déjà existante.
              User password: {{ result.password }}
              {% elif not result.db_exists and result.user_exists %}
              L'utilisateur {{ result.user }} existe déjà et recevra les privilèges pour la base de données {{ result.database }} créée.
              User password: {{ result.password }}
              {% else %}
              La base de données {{ result.database }} et l'utilisateur MySQL {{ result.user }} existent déjà.
              Veuillez contacter le service DSI/A2I/DBA.
              {% endif %}
              IP address: {{ db_ip }}
              Port: {{ db_port }}
              {% endfor %}
          when: db_results|length > 0
      delegate_to: '10.137.21.115'
