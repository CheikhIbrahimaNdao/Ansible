# Backup databases

- name: Set backup date and time variables
  set_fact:
    backup_date: "{{ dba_backup_time | regex_replace('T.*', '') | regex_replace('-', '') }}"
    backup_time: "{{ dba_backup_time | regex_replace('.*T', '') | regex_replace(':', '') | regex_replace('\\..*', '') }}"

- name: Set backup file name and directory
  set_fact:
    backup_file_name: "{{ dba_name_db }}_{{ backup_time }}"
    full_backup_dir: "/data/{{ dba_name_app }}/backup_{{ backup_date }}"
  
- name: Ensure backup directory exists
  file:
    path: "{{ full_backup_dir }}"
    state: directory
    mode: '0755'
    recurse: yes
  
- name: Check if database exists
  expect:
    command: "mysql -u{{ db_user }} -p -h{{ env.db_ip }} -P{{ env.db_port }} -e 'SELECT schema_name FROM information_schema.schemata WHERE schema_name = \"{{ dba_name_db }}\";'"
    responses:
      "Enter password:": "{{ db_user_password }}"
  register: db_check

- name: Display message if database does exist
  debug:
    msg: "{{ dba_name_db }} exists"
  when: db_check.stdout_lines | length != 1
  
- name: Exécuter les tâches suivantes seulement si la vérification a réussi
  block:
    - name: Backup MySQL databases
      mysql_db:
        state: dump
        name: "{{ dba_name_db }}"
        target: "{{ full_backup_dir }}/{{ backup_file_name }}.sql"
        login_password: "{{ db_user_password }}"
        login_user: "{{ db_user }}"
        login_host: "{{ env.db_ip }}"
        login_port: "{{ env.db_port }}"
    
    - name: Compress the SQL dump file
      command: "gzip {{ full_backup_dir }}/{{ backup_file_name }}.sql"
      args:
        creates: "{{ full_backup_dir }}/{{ backup_file_name }}.sql.gz"

    - name: Envoyer un email avec les détails de la base de données et de l'utilisateur créés
      mail:
        host: "webmail.orange-sonatel.com"
        port: 25
        to: "{{ demandeur }}"
        cc:
          - "CheikhIbrahima.NDAO@orange-sonatel.com"
          #- "Admin_dba@orange-sonatel.com"
        from: "{{ approbateur }}"
        subject: "Détails de la base de données à sauvegarder"
        body: |
          La base de données {{ dba_name_db }} a été sauvegardée avec succées.
  when: db_check.stdout_lines | length != 1

- name: Envoyer un email avec les détails de la base de données et de l'utilisateur créés
  mail:
    host: "webmail.orange-sonatel.com"
    port: 25
    to: "{{ demandeur }}"
    cc:
      - "CheikhIbrahima.NDAO@orange-sonatel.com"
      #- "Admin_dba@orange-sonatel.com"
    from: "{{ approbateur }}"
    subject: "Détails de la base de données à sauvegarder"
    body: |
      La base de données {{ dba_name_db }} n'existe pas.
      Veuillez vérifier le nom de la base de données à sauvegarder ou contacter le service DSI/A2I/DBA.
      ticket_id: {{ ticket_id }}
  when: db_check.stdout_lines | length == 1